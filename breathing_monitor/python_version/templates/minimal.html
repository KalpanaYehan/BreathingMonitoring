<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Breathing Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            height: 400px;
            overflow: auto;
            border: 1px solid #dee2e6;
        }
        #breathingChart {
            width: 100% !important;
            height: 400px !important;
            min-width: 800px;
            min-height: 400px;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .respiration-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .respiration-result h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }
        .result-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .result-label {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .result-status {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        .data-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .camera-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
        }
        #cameraFeed {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 3px solid #28a745;
        }
        .camera-instructions {
            margin-top: 15px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            font-size: 0.9em;
            color: #155724;
            max-width: 400px;
        }
        .camera-instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .camera-instructions li {
            margin: 5px 0;
        }
        .chart-instructions {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 5px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #2e7d32;
        }
        .chart-instructions ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .chart-instructions li {
            margin: 4px 0;
        }
        /* Custom scrollbar styling */
        .chart-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .chart-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 6px;
        }
        .chart-container::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
        .chart-container::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }
        .scroll-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #856404;
            text-align: center;
        }
        .scroll-info li {
            margin: 4px 0;
        }
        .zoom-controls {
            text-align: center;
            margin: 15px 0;
        }
        .zoom-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .zoom-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Breathing Monitor</h1>
        
        <div class="info">
            <strong>Instructions:</strong>
            <ol>
                <li>Click "Start Monitoring"</li>
                <li>Position yourself in the camera view</li>
                <li>Stay still and breathe normally</li>
                <li>Watch the breathing graph</li>
                <li>Click "Stop Monitoring" when done</li>
            </ol>
        </div>
        
        <div class="controls">
            <button id="startBtn">üöÄ Start Monitoring</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Stop Monitoring</button>
        </div>
        
        <div class="status" id="status">
            Ready to start monitoring
        </div>
        
        <div class="respiration-result" id="respirationResult" style="display: none;">
            <h3>üìä Respiration Rate Analysis</h3>
            <div class="result-value" id="respirationRate">--</div>
            <div class="result-label">breaths per minute</div>
            <div class="result-status" id="respirationStatus">--</div>
        </div>
        
        <div class="data-display">
            <div>Data Points: <span class="data-value" id="dataPoints">0</span></div>
        </div>
        
        <div class="camera-section">
            <h3>üìπ Camera View - Position Yourself in the Green Box</h3>
            <div class="camera-container">
                <img id="cameraFeed" src="/video_feed" alt="Camera Feed" />
                <div class="camera-instructions">
                    <!-- <p><strong>Positioning Guide:</strong></p>
                    <ul>
                        <li>‚úÖ Sit/stand in the center of the frame</li>
                        <li>‚úÖ Ensure your chest is within the green rectangle</li>
                        <li>‚úÖ Stay relatively still (minimal movement)</li>
                        <li>‚úÖ Breathe normally and naturally</li>
                        <li>‚ùå Avoid sudden movements or talking</li>
                    </ul> -->
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <!-- <h3>üìä Breathing Pattern</h3>
            <div class="scroll-info">
                <p><strong>üì± Simple Chart:</strong> Fixed 60-second X-axis (0-60s) and fixed Y-axis (0-20) for consistent viewing</p>
                <p><strong>üîç Zoom Controls:</strong> Use mouse wheel to zoom in/out, drag to pan, and click "Reset Zoom" to return to full view</p>
            </div> -->
            <div class="zoom-controls">
                <button id="resetZoomBtn" class="zoom-btn">üîç Reset Zoom</button>
            </div>
            <canvas id="breathingChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script>
        class MinimalBreathingMonitor {
            constructor() {
                this.chart = null;
                this.updateInterval = null;
                this.isMonitoring = false;
                
                this.initializeChart();
                this.setupEventListeners();
                this.initializeCameraFeed();
            }
            
            initializeCameraFeed() {
                // Initially hide camera feed until monitoring starts
                const cameraFeed = document.getElementById('cameraFeed');
                if (cameraFeed) {
                    cameraFeed.style.display = 'none';
                }
            }
            
            initializeChart() {
                const ctx = document.getElementById('breathingChart').getContext('2d');
                
                // Create simple chart with FIXED axes
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Breathing',
                            data: [],
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: 'x'
                                },
                                zoom: {
                                    wheel: {
                                        enabled: true
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'xy',
                                    drag: {
                                        enabled: true,
                                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                        borderColor: '#007bff',
                                        borderWidth: 1
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                min: 0,
                                max: 60,  // Fixed 60-second X-axis
                                ticks: {
                                    stepSize: 10,  // 10-second intervals
                                    maxTicksLimit: 6
                                },
                                grid: {
                                    display: true
                                },
                                title: {
                                    display: true,
                                    text: 'Time (seconds)'
                                }
                            },
                            y: {
                                type: 'linear',
                                min: 15,
                                max: 30,// Fixed Y-axis range
                                ticks: {
                                    stepSize: 0.25,// 2-unit intervals
                                    maxTicksLimit: 10
                                },
                                grid: {
                                    display: true
                                },
                                title: {
                                    display: true,
                                    text: 'Breathing Value'
                                }
                            }
                        }
                    }
                });
            }
            
            setupEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.startMonitoring());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopMonitoring());
                document.getElementById('resetZoomBtn').addEventListener('click', () => this.resetZoom());
            }
            
            resetZoom() {
                if (this.chart) {
                    this.chart.resetZoom();
                    console.log('Zoom reset to full view');
                }
            }
            
            async startMonitoring() {
                try {
                    console.log('Starting monitoring...'); // Debug log
                    this.updateStatus('Starting monitoring...', 'warning');
                    
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    console.log('Response received:', response); // Debug log
                    const result = await response.json();
                    console.log('Result:', result); // Debug log
                    
                    if (result.success) {
                        this.isMonitoring = true;
                        this.updateStatus('Monitoring active! Stay still and breathe normally.', 'success');
                        this.updateButtonStates();
                        this.clearChart();
                        this.hideRespirationResult();
                        this.startDataUpdates();
                        console.log('Monitoring started successfully'); // Debug log
                    } else {
                        this.updateStatus('Failed to start monitoring', 'error');
                        console.error('Failed to start monitoring'); // Debug log
                    }
                    
                } catch (error) {
                    console.error('Error starting monitoring:', error);
                    this.updateStatus('Error starting monitoring: ' + error.message, 'error');
                }
            }
            
            async stopMonitoring() {
                try {
                    this.updateStatus('Stopping monitoring...', 'warning');
                    
                    const response = await fetch('/api/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.isMonitoring = false;
                        this.updateStatus('Monitoring stopped.', 'success');
                        this.updateButtonStates();
                        this.stopDataUpdates();
                        
                        // Display respiration rate if available
                        this.displayRespirationRate(result.respiration_rate);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.updateStatus('Error stopping monitoring', 'error');
                }
            }
            
            async updateData() {
                try {
                    const response = await fetch('/api/data');
                    const data = await response.json();
                    
                    // Update data points count
                    document.getElementById('dataPoints').textContent = data.data_count || 0;
                    
                    // Update chart ONLY if monitoring and have data
                    if (data.is_monitoring && data.breathing_data && data.breathing_data.length > 0) {
                        this.updateChart(data.breathing_data, data.timestamps);
                    }
                    
                } catch (error) {
                    console.error('Error updating data:', error);
                }
            }
            
            updateChart(breathingData, timestamps) {
                try {
                    if (!breathingData || breathingData.length === 0) return;
                    
                    console.log('Updating chart with data:', breathingData.length, 'points');
                    
                    // Simple data update - no complex scaling
                    this.chart.data.labels = timestamps.map(t => t.toFixed(1));
                    this.chart.data.datasets[0].data = breathingData;
                    
                    // Update chart with fixed axes
                    this.chart.update('none');
                    console.log('Chart updated successfully');
                    
                } catch (error) {
                    console.error('Error updating chart:', error);
                }
            }
            
            clearChart() {
                // Clear chart data
                this.chart.data.labels = [];
                this.chart.data.datasets[0].data = [];
                
                // Update chart
                this.chart.update('none');
            }
            
            updateButtonStates() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const cameraFeed = document.getElementById('cameraFeed');
                
                if (this.isMonitoring) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    // Show camera feed when monitoring
                    cameraFeed.style.display = 'block';
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    // Hide camera feed when not monitoring
                    cameraFeed.style.display = 'none';
                }
            }
            
            displayRespirationRate(rate) {
                const resultElement = document.getElementById('respirationResult');
                const rateElement = document.getElementById('respirationRate');
                const statusElement = document.getElementById('respirationStatus');
                
                if (rate !== null && rate !== undefined && rate !== "N/A" && typeof rate === 'number') {
                    rateElement.textContent = rate.toFixed(1);
                    
                    // Determine status based on normal ranges
                    if (rate < 12) {
                        statusElement.textContent = 'Slow breathing (normal for relaxation)';
                    } else if (rate <= 20) {
                        statusElement.textContent = 'Normal breathing rate';
                    } else if (rate <= 25) {
                        statusElement.textContent = 'Slightly elevated (normal for activity)';
                    } else {
                        statusElement.textContent = 'Elevated breathing rate';
                    }
                    
                    resultElement.style.display = 'block';
                } else {
                    rateElement.textContent = 'N/A';
                    if (rate === "N/A") {
                        statusElement.textContent = 'Insufficient or irregular breathing data';
                    } else {
                        statusElement.textContent = 'Insufficient data for analysis';
                    }
                    resultElement.style.display = 'block';
                }
            }
            
            hideRespirationResult() {
                const resultElement = document.getElementById('respirationResult');
                resultElement.style.display = 'none';
            }
            
            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                
                // Remove existing status classes
                statusElement.className = 'status';
                
                // Add type-specific styling
                if (type === 'success') {
                    statusElement.style.background = '#d4edda';
                    statusElement.style.color = '#155724';
                } else if (type === 'warning') {
                    statusElement.style.background = '#fff3cd';
                    statusElement.style.color = '#856404';
                } else if (type === 'error') {
                    statusElement.style.background = '#f8d7da';
                    statusElement.style.color = '#721c24';
                }
                
                statusElement.textContent = message;
            }
            
            startDataUpdates() {
                this.updateInterval = setInterval(() => {
                    this.updateData();
                }, 1000); // Update every 1 second for higher frequency data
            }
            
            stopDataUpdates() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MinimalBreathingMonitor();
        });
    </script>
</body>
</html>
